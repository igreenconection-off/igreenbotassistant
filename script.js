const API_KEY = 'AIzaSyABq8rgWLgxbFfG6p9dnyBsqgxma4NUUZQ'; 
const MODELO = 'gemini-1.5-flash';

const BANCO_DE_DADOS_TEXTO = `Este documento reúne informações básicas dos produtos oferecidos pela igreen Energy... Este documento reúne informações básicas dos produtos oferecidos pela igreen Energy.

Insumos extra:
Site: igreenconection-off.github.io/IGREENCONECTION
Atendimento por whatsapp: wa.me/5584920039738 


Os produtos ofertados são: Conexão Green (o carro chefe), conexão placas, conexão solar, conexão livre, conexão Telecom, conexão expansão.

Conexão Green: trata-se do procedimento de portabilidade da energia. A igreen Energy possui parceria com fazendas de energia solar da thopen, e quando um cliente faz o cadastro da conexão Green, a igreen Energy entra em contato com a distribuidora de energia do cliente e realiza o procedimento de cadastro de créditos de energia. Para o cliente, ele recebe um desconto na fatura de até 15%, mas na verdade, toda a energia que ele consome mensalmente e que é entregue pela distribuidora, é abatida pelos créditos de energia da igreen, pois a energia é injetada na rede elétrica e o cliente paga diretamente a igreen o que usou, mas com um desconto. Isso contribui para um planeta mais sustentável, pois essa simples atitude, além de trazer benefício para o cliente, reduz os impactos ambientais do consumo de energia elétrica. O cliente não paga mais bandeiras tarifárias, pois a energia solar não depende de rios, e possui baixa manutenção. Além disso, o cliente participa de um clube de benefícios chamado clube certo, do igreen club, onde ele tem acesso a desconto em várias empresas parceiras de vários segmentos, como supermercados, academias, oficinas automotivas, varejistas online e muito mais! Sem falar no programa de indicações, onde cada pessoa que for indicada pelo cliente e for aprovada, gera ainda mais desconto para quem indicou, podendo até mesmo zerar a fatura!

Os requisitos para realizar o seu cadastro na conexão Green são:
Consumo médio de 130kwh (que dá aproximadamente 150 reais por mês);
Ser o titular;
Não estar cadastrado em programas sociais de baixa renda, possuir NIS cadastrado na fatura/tarifa social;
Não possuir placa solar em casa;
Estar em dias com a distribuidora.

Caso alguma das informações esteja incorreta, o cliente poderá receber uma mensagem por whatsapp solicitando a correção. Por exemplo, se as imagens ou PDFs da fatura, ou dos documentos estiverem incompletos ou ilegíveis, será necessário reenviar. Caso o reenvio não seja feito em até 30 dias, o cadastro será cancelado, mas ainda há possibilidade de fazer um novo cadastro. Caso o cliente faça o cadastro mas não esteja em dias com a distribuidora, será solicitado envio do comprovante de pagamento, para que o cliente regularize sua situação com a distribuidora o mais rápido possível. Cadastros de devedores serão recusados se não for enviado o comprovante de pagamento.

Após realizar o cadastro, ele vai para análise, onde serão localizadas as irregularidades mencionadas anteriormente. Caso esteja tudo certo, o acordo entre a igreen e a distribuidora segue, podendo levar até 90 dias para a aprovação, contando a partir do dia do cadastramento. O cliente deverá receber uma mensagem por whatsapp informando que o cadastro foi aprovado. Caso ultrapasse o período de 90 dias, sem uma resposta, é provável que não tenha sido aprovado, mas é recomendável contatar a igreen atraves do whatsapp (https://wa.me/5584920039738) e caso já tenha sido aprovado, mas o cliente ainda não estiver recebendo os boletos da igreen por whatsapp, email e app igreen club, mas ainda estiver com o boleto normal da distribuidora com o valor total do consumo sem desconto, significa que a negociação com a distribuidora ainda não terminou, e será necessário aguardar um pouco mais, para que a distribuidora autorize os créditos e o cliente possa receber os boletos da igreen com desconto. Caso o cliente acredite que não fez o cadastro conosco, foi coagido, enganado, ou que o cadastro foi feito por outra pessoa se passando por ele, ou ainda que ele queira cancelar por desistência ou qualquer motivo, ele pode cancelar a qualquer momento pelo telefone 0800 000 6227.

Se um cliente que fez o cadastro da conexão Green e agora já recebe o desconto decidir colocar placa solar em casa, ele poderá fazer isso sem problemas. O contrato com a igreen Energy será cancelado automaticamente sem gerar custos. 

O cadastro da conexão Green é 100% gratuito, não exige investimentos ou pagamentos de taxas, não gera multas e é regulamentado pela lei federal 14300.

Caso o cliente decida contratar os serviços de energia elétrica por assinatura com outra empresa que não seja a igreen, ele estará livre para isto, pois o nosso serviço de energia por assinatura (conexão Green) não possui contrato de fidelidade, e pode ser cancelado a partir do momento da contratação.

Se um cliente desejar indicar outro cliente, ele pode fazer isso direto pelo app igreen club indo em menu > meu link de conexão Green. A outra pessoa pode clicar no link, fazer o próprio cadastro, e assim, se for aprovada, renderá de 1% a 10% a mais de desconto para o cliente que fez a indicação. A indicação não tem limites, pode até zerar a fatura do cliente para sempre. Além disso, o Cashback sustentável garante que o cliente receba uma “comissão” por cada indicação, além do direito à roleta de prêmios.

Para realizar o cadastro da conexão Green no autoatendimento, o cliente poderá acessar o site e clicar no botão de atendimento chat com chatbot e escolher a opção conexão Green. Desse modo poderá seguir com o autoatendimento e fazer o próprio cadastro.

Conexão solar: O conexão solar, é um modelo alternativo para adquirir um sistema solar fotovoltaico sem investimentos. Com ele, a igreen Energy aluga o telhado do cliente, e o pagamento do aluguel será o próprio sistema solar. Primeiramente, o cliente precisa ser o titular e possuir consumo de 300kwh no mínimo. Depois, a equipe da igreen vai na casa do cliente fazer uma vistoria, para depois fazer a instalação da mini usina de geração distribuída. O contrato firmado entre o cliente e a igreen prevê um período específico para o aluguel a partir de 6 anos. Durante esse período, o sistema solar fotovoltaico no telhado do cliente vai gerar energia para a igreen, e o cliente vai ficar usando essa energia e pagando por ela, cadastrado na energia solar por assinatura, recebendo desconto, participando do clube, e livre das bandeiras. Quando o período acabar, o cliente será proprietário integral do sistema solar fotovoltaico, e poderá usufruir livremente, estando livre da energia por assinatura e sem dever mais nada a igreen, como se tivesse comprado o sistema.

Conexão placas: o conexão placas é o produto mais genérico do mercado de energia solar: a compra das placas. O pagamento pode ser feito por cartão de crédito, financiamento pelo banco do cliente, financiamento pelos bancos parceiros da igreen, ou pagamento a vista. Para que seja feita a contratação é necessário que o consumo seja igual ou superior a 250kwh, mas caso o consumo do cliente seja inferior e mesmo assim ele deseje contratar, é possível fazer a contratação, desde que o sistema seja dimensionado para produzir a partir de 250kwh.

Conexão livre: o produto conexão livre é basicamente a mesma coisa do conexão Green, mas com benefícios exclusivos para empresas de grande porte.

Conexão Telecom: o produto conexão Telecom é referente a operadora iGreen Telecom. A operadora igreen Telecom é uma operadora digital em nuvem, que opera sem torres próprias, conectando-se a torres de outras operadoras próximas para garantir o melhor sinal. A conexão é quase sem fronteiras, a internet é altamente veloz, podendo alcançar conexão 5g. Possui diversos planos que incluem benefícios diversos, como a internet que acumula e whatsapp ilimitado. O uso da operadora também concede benefícios como igreen club com clube certo, programa de indicações, roleta de prêmios e outros benefícios da conexão Green não relacionados a energia. A operadora oferece duas modalidades de contração: nova linha, ou portabilidade. Apesar de a operadora ser brasileira, já está disponível para Estados Unidos e Canadá.

Conexão expansão: o conexão expansão é uma oportunidade de trabalho por meio de franquia, onde o comprador da franquia se torna um licenciado da igreen Energy, autorizado na área de publicidade dos produtos. Cada cadastro na conexão Telecom, livre ou Green pelo link do licenciado, gera uma renda passiva com valores recorrentes, além das comissões nas conexões solar e placas. Quando um licenciado compra a franquia pelo link de outro licenciado, formam uma equipe, onde o licenciado que vendeu a franquia recebe um percentual específico sobre cada cadastro que o novo licenciado fizer. Além disso, a igreen Energy também cria eventos mensais com bônus extra, comissões mais altas, prêmios como motocicletas e carros elétricos, viagens e prêmios em dinheiro. A igreen também fornece treinamentos para conexão solar e placas toda quarta-feira ao vivo no YouTube, mas as aulas ficam gravadas. Além disso, existe uma plataforma chamada igreen academy, por onde o licenciado deve estudar todos os módulos e ser aprovado nos testes antes de vender o produto daquele módulo.
`;

const SYSTEM_PROMPT = `Você é a Assistente IA da iGreen Energy. Use apenas o BANCO DE DADOS fornecido.`;

// FUNÇÃO PRINCIPAL DE INICIALIZAÇÃO
function inicializarBot() {
    const sendBtn = document.getElementById("send-btn");
    const userInput = document.getElementById("user-input");

    if (sendBtn && userInput) {
        // Remove ouvintes antigos para evitar duplicidade e adiciona o novo
        sendBtn.onclick = sendMessage; 
        
        userInput.onkeypress = (e) => {
            if (e.key === "Enter") sendMessage();
        };
        console.log("Botão de enviar e campo de texto configurados com sucesso!");
    } else {
        console.error("Erro: Não encontrei o botão 'send-btn' ou o campo 'user-input' no HTML.");
    }
}

// Garante que o script rode apenas após o HTML carregar completamente
if (document.readyState === "complete" || document.readyState === "interactive") {
    inicializarBot();
} else {
    document.addEventListener("DOMContentLoaded", inicializarBot);
}

async function sendMessage() {
    const input = document.getElementById("user-input");
    const userText = input.value.trim();
    
    if (!userText) return;

    addMessageToChat(userText, "user");
    input.value = "";

    const typingId = "typing-" + Date.now();
    addMessageToChat("Processando...", "bot", typingId);

    try {
        const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/${MODELO}:generateContent?key=${API_KEY}`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                contents: [{
                    parts: [{ text: `${SYSTEM_PROMPT}\n\nBANCO DE DADOS:\n${BANCO_DE_DADOS_TEXTO}\n\nPergunta: ${userText}` }]
                }],
                generationConfig: { maxOutputTokens: 2048, temperature: 0.3 }
            })
        });

        const data = await response.json();

        if (data.error) {
            updateBotMessage(typingId, "Erro técnico: " + data.error.message);
            return;
        }

        if (data.candidates && data.candidates[0].content) {
            const botResponse = data.candidates[0].content.parts[0].text;
            updateBotMessage(typingId, botResponse);
        }
    } catch (error) {
        updateBotMessage(typingId, "Erro de conexão. Verifique sua internet.");
        console.error(error);
    }
}

function updateBotMessage(id, newText) {
    const msgElement = document.getElementById(id);
    if (msgElement) {
        const bubble = msgElement.querySelector(".bubble");
        if (bubble) bubble.innerText = newText;
    }
}

function addMessageToChat(text, sender, id = null) {
    const container = document.getElementById("chat-container");
    if (!container) return;

    const div = document.createElement("div");
    div.className = `message ${sender}-message`;
    if (id) div.id = id;
    
    const avatar = sender === "bot" ? `<img src="https://c.topshort.org/aifacefy/ai_face_generator/template/1.webp" class="msg-avatar">` : "";
    div.innerHTML = `${avatar}<div class="bubble">${text}</div>`;
    
    container.appendChild(div);
    container.scrollTop = container.scrollHeight;
}
